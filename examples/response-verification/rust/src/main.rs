use candid::{Decode, Principal};
use ic_http_certification::{HttpRequest, HttpResponse};
use ic_response_verification::{verify_request_response_pair, MIN_VERIFICATION_VERSION};

fn main() {
    let request_hex = "4449444C046D7B6C02007101716D016C04EFD6E40271E1EDEB4A71A2F5ED880400C6A4A19806020103012F03474554000704486F73742372646D78362D6A616161612D61616161612D61616164712D6361692E6963302E617070066163636570748701746578742F68746D6C2C6170706C69636174696F6E2F7868746D6C2B786D6C2C6170706C69636174696F6E2F786D6C3B713D302E392C696D6167652F617669662C696D6167652F776562702C696D6167652F61706E672C2A2F2A3B713D302E382C6170706C69636174696F6E2F7369676E65642D65786368616E67653B763D62333B713D302E39097365632D63682D756128224368726F6D69756D223B763D22313037222C20224E6F743D413F4272616E64223B763D22323422107365632D63682D75612D6D6F62696C65023F30127365632D63682D75612D706C6174666F726D092257696E646F77732219757067726164652D696E7365637572652D726571756573747301310A757365722D6167656E74744D6F7A696C6C612F352E30202857696E646F7773204E542031302E303B2057696E36343B2078363429204170706C655765624B69742F3533372E333620284B48544D4C2C206C696B65204765636B6F29204368726F6D652F3130372E302E353330342E313037205361666172692F3533372E3336";
    let request_candid = hex::decode(request_hex).expect("Could not decode request from hex");
    let http_request =
        Decode!(&request_candid, HttpRequest).expect("Could not decode request from candid");
    let request = HttpRequest {
        method: "GET".into(),
        url: http_request.url,
        headers: http_request.headers,
        body: vec![],
    };
    println!("***Request***");
    println!("Url: {:?}", request.url);
    println!("Headers: {:#?}", request.headers);
    println!("\n\n");

    let ic_root_key: &[u8; 133] = b"\x30\x81\x82\x30\x1d\x06\x0d\x2b\x06\x01\x04\x01\x82\xdc\x7c\x05\x03\x01\x02\x01\x06\x0c\x2b\x06\x01\x04\x01\x82\xdc\x7c\x05\x03\x02\x01\x03\x61\x00\x81\x4c\x0e\x6e\xc7\x1f\xab\x58\x3b\x08\xbd\x81\x37\x3c\x25\x5c\x3c\x37\x1b\x2e\x84\x86\x3c\x98\xa4\xf1\xe0\x8b\x74\x23\x5d\x14\xfb\x5d\x9c\x0c\xd5\x46\xd9\x68\x5f\x91\x3a\x0c\x0b\x2c\xc5\x34\x15\x83\xbf\x4b\x43\x92\xe4\x67\xdb\x96\xd6\x5b\x9b\xb4\xcb\x71\x71\x12\xf8\x47\x2e\x0d\x5a\x4d\x14\x50\x5f\xfd\x74\x84\xb0\x12\x91\x09\x1c\x5f\x87\xb9\x88\x83\x46\x3f\x98\x09\x1a\x0b\xaa\xae";
    let response_hex = "4449444C096C04A2F5ED880401C6A4A1980602B09699E20C049AA1B2F90C7A6D7B6D036C02007101716E056B01E5ABE1C505066C02F985AEA10107C5B39AF807086C006A0000000100FC083C21646F63747970652068746D6C3E3C68746D6C206C616E673D22656E223E3C686561643E3C6D65746120636861727365743D225554462D38222F3E3C6D65746120687474702D65717569763D22582D55412D436F6D70617469626C652220636F6E74656E743D2249453D65646765222F3E3C6D657461206E616D653D2276696577706F72742220636F6E74656E743D2277696474683D6465766963652D77696474682C696E697469616C2D7363616C653D31222F3E3C6D65746120687474702D65717569763D22436F6E74656E742D53656375726974792D506F6C6963792220636F6E74656E743D2264656661756C742D73726320276E6F6E65273B636F6E6E6563742D737263202773656C66272068747470733A2F2F6963302E6170702068747470733A2F2F2A2E6963302E6170703B696D672D737263202773656C662720646174613A3B7363726970742D73726320277368613235362D61654F646F4D4C7A562B716D6B49646159693364514A2B61507855514C464461496A34312F6378394463413D272027756E736166652D696E6C696E65272027756E736166652D6576616C2720277374726963742D64796E616D6963272068747470733A3B626173652D75726920276E6F6E65273B666F726D2D616374696F6E20276E6F6E65273B7374796C652D737263202773656C66272027756E736166652D696E6C696E65272068747470733A2F2F666F6E74732E676F6F676C65617069732E636F6D3B7374796C652D7372632D656C656D202773656C66272027756E736166652D696E6C696E65272068747470733A2F2F666F6E74732E676F6F676C65617069732E636F6D3B666F6E742D7372632068747470733A2F2F666F6E74732E677374617469632E636F6D3B757067726164652D696E7365637572652D72657175657374733B22202F3E3C7469746C653E496E7465726E6574204964656E746974793C2F7469746C653E3C6C696E6B2072656C3D2273686F72746375742069636F6E2220747970653D22696D6167652F6A70672220687265663D222E2F66617669636F6E2E69636F222F3E3C6C696E6B2072656C3D227374796C6573686565742220687265663D222E2F696E6465782E637373222F3E3C2F686561643E3C626F64793E3C6D61696E2069643D2270616765436F6E74656E742220636C6173733D226C2D777261702220617269612D6C6976653D22706F6C697465223E3C2F6D61696E3E3C6469762069643D226E6F74696669636174696F6E223E3C2F6469763E3C6469762069643D226C6F61646572436F6E7461696E6572223E3C2F6469763E3C73637269707420646174612D63616E69737465722D69643D2272646D78362D6A616161612D61616161612D61616164712D636169222069643D2273657475704A73223E6C65742073203D20646F63756D656E742E637265617465456C656D656E74282773637269707427293B732E6173796E63203D20747275653B732E737263203D2027696E6465782E6A73273B646F63756D656E742E686561642E617070656E644368696C642873293B3C2F7363726970743E3C2F626F64793E3C2F68746D6C3E080F582D4672616D652D4F7074696F6E730444454E5916582D436F6E74656E742D547970652D4F7074696F6E73076E6F736E69666617436F6E74656E742D53656375726974792D506F6C696379CC0364656661756C742D73726320276E6F6E65273B636F6E6E6563742D737263202773656C66272068747470733A2F2F6963302E6170702068747470733A2F2F2A2E6963302E6170703B696D672D737263202773656C662720646174613A3B7363726970742D73726320277368613235362D61654F646F4D4C7A562B716D6B49646159693364514A2B61507855514C464461496A34312F6378394463413D272027756E736166652D696E6C696E65272027756E736166652D6576616C2720277374726963742D64796E616D6963272068747470733A3B626173652D75726920276E6F6E65273B666F726D2D616374696F6E20276E6F6E65273B7374796C652D737263202773656C66272027756E736166652D696E6C696E65272068747470733A2F2F666F6E74732E676F6F676C65617069732E636F6D3B7374796C652D7372632D656C656D202773656C66272027756E736166652D696E6C696E65272068747470733A2F2F666F6E74732E676F6F676C65617069732E636F6D3B666F6E742D7372632068747470733A2F2F666F6E74732E677374617469632E636F6D3B757067726164652D696E7365637572652D72657175657374733B6672616D652D616E636573746F727320276E6F6E65273B195374726963742D5472616E73706F72742D5365637572697479246D61782D6167653D3331353336303030203B20696E636C756465537562446F6D61696E730F52656665727265722D506F6C6963790B73616D652D6F726967696E125065726D697373696F6E732D506F6C696379F005616363656C65726F6D657465723D28292C616D6269656E742D6C696768742D73656E736F723D28292C6175746F706C61793D28292C626174746572793D28292C63616D6572613D28292C636C6970626F6172642D726561643D28292C636C6970626F6172642D77726974653D2873656C66292C636F6E76657273696F6E2D6D6561737572656D656E743D28292C63726F73732D6F726967696E2D69736F6C617465643D28292C646973706C61792D636170747572653D28292C646F63756D656E742D646F6D61696E3D28292C656E637279707465642D6D656469613D28292C657865637574696F6E2D7768696C652D6E6F742D72656E64657265643D28292C657865637574696F6E2D7768696C652D6F75742D6F662D76696577706F72743D28292C666F6375732D776974686F75742D757365722D61637469766174696F6E3D28292C66756C6C73637265656E3D28292C67616D657061643D28292C67656F6C6F636174696F6E3D28292C6779726F73636F70653D28292C6869643D28292C69646C652D646574656374696F6E3D28292C696E7465726573742D636F686F72743D28292C6B6579626F6172642D6D61703D28292C6D61676E65746F6D657465723D28292C6D6963726F70686F6E653D28292C6D6964693D28292C6E617669676174696F6E2D6F766572726964653D28292C7061796D656E743D28292C706963747572652D696E2D706963747572653D28292C7075626C69636B65792D63726564656E7469616C732D6765743D2873656C66292C73637265656E2D77616B652D6C6F636B3D28292C73657269616C3D28292C737065616B65722D73656C656374696F6E3D28292C73796E632D7363726970743D28292C73796E632D7868723D2873656C66292C74727573742D746F6B656E2D726564656D7074696F6E3D28292C7573623D28292C766572746963616C2D7363726F6C6C3D28292C7765622D73686172653D28292C77696E646F772D706C6163656D656E743D28292C78722D7370617469616C2D747261636B696E673D28290E49432D4365727469666963617465A30D63657274696669636174653D3A32646E336F325230636D566C6777474441594D4267774A495932467561584E305A584B44416B6F414141414141414141427745426777474441594D4267774A4F5932567964476C6D6157566B5832526864474743413167673265392B4757545957773667694D6B786A4A453764785575464D4F6D6F454A3330464652544F596D5A2B3643424667672F56745A525A6459794B2F7372334B46326A5765533172626C462B34616A77664476325A62434770615469434246676736484B454D466D596E396A3073464852784343444E5857544C6E444D6277347444766B395268326750796D43424667674B4271643855665354646373626E7A514C5A50585659734A4C4D3664632F66692B526C635739442F574A47434246676767414734516F507542706455443969664D73343043766E39766E307761684C6A53544D4F42734D5634694343424667676F6177694544442B446E425469356A394E6A4C484D574846416C5761566B342B32362B756C774655594A3644415949455743414C4C784C506736696A4F576B6344546D2B4F454D733768706B326F34346D4C74707239747063494938586F4D43524852706257574341306D7673593375734E714D6C52647063326C6E626D463064584A6C574443476E793072374B4F56457A51736F55345552752F6A7465422B634F3475773878353957675033616B634D3468515A32464C56746257774B6758324F584B424256715A4756735A57646864476C7662714A7063335669626D563058326C6B57423144334B3852674E75432F6163497A6A72486F447067594B7665452B6C556247446F7A4F5A64416D746A5A584A3061575A70593246305A566B4362746E5A39364A6B64484A6C5A594D4267675259494F64534A7846313734576158326E372B50725654736B6779496E454B49342B71643139486B546D7044347567774744416B5A7A64574A755A58534441594D4267774743424667674A6E2F6C55524731626A773564564D756F7A632F65334C702B4342792F6F356766744E45686B654B577A6D444159494557434247616E416F62506D73365941637054346972323767576143552F57424A68676255684C61465146677766594D426777474342466767697939734651654B354E4F354E484352584B552B4E7A4D6E3833366E5336473446333259613765624D613644416C676451397976455944626776326E434D343678364136594743723368507056477867364D7A6D58514B4441594D4354324E68626D6C7A6447567958334A68626D646C6334494457444C5A32666543676B6F41414141414141414142774542536741414141414141414148415147435367414141414143454141414151464B41414141414149662F2F384241594D43536E4231596D7870593139725A586D43413169464D4947434D42304744537347415151426774783842514D424167454744437347415151426774783842514D4341514E6841495A31746A536B506A6C79596A6A5034357956474C772B4D69584C6231714565622F504B324350756D2B464A4E7934447A576F726B533066795976436D596731424A3538472F677854707A6E387967476B6953622B5A526F314762577A4B662B2B7A4A384D755169776D4E302B69455850755A78574E3534456D73526C3749426F4945574343487A5345325230336D424968357737634341464E575558413979584C4B79355436426C2F2B4C755932696F49455743424B485862416A6D5175506261594C6D5A54766F787A627964614A4B776945494E444379316252427A6E5649494557434174685775366532794146787A6F3564456875333545554C4E57576D524E6B5458702F6C69454B42776675594D43524852706257574341306D31306F7663793453576C42647063326C6E626D463064584A6C5744437436794F51734A36795863783857625061624333325034667373357A43415968312F4A616C31656E634A577171786241443953767A37627343495957733145633D3A2C20747265653D3A32646E3367774744416B746F644852775832467A6332563063344D4267774744416B457667674E594948684D44344A616B34716E39484659664E3938643562344B506B324A4A58697563684A447949794E5A766267675259494E664E436D7A314B6942773346482B485874716877654969484765466F536364497731352F783761666C6367675259494667725579457A5A6B62556A472B4C385A457A4D37744F763258416E2F7634494877424C68395542784A68676752594943457A53795A6F4858496734394C58334C493669637A624778344554724E65752B5352396D3141674E42343A0C436F6E74656E742D5479706509746578742F68746D6C00C800";
    let response_candid = hex::decode(response_hex).expect("Could not decode response from hex");
    let http_response =
        Decode!(&response_candid, HttpResponse).expect("Could not decode response from candid");

    let response = HttpResponse {
        status_code: 200,
        headers: http_response.headers,
        body: http_response.body,
        upgrade: None,
    };
    println!("***Response***");
    println!("Body: {:?}", response.body);
    println!("Headers: {:#?}", response.headers);
    println!("\n\n");

    let canister_id = Principal::from_text("rdmx6-jaaaa-aaaaa-aaadq-cai")
        .expect("Could not decode principal from text");

    let current_time_ns = 1669202493944584367;
    let max_cert_time_offset_ns = 300_000_000_000;
    let result = verify_request_response_pair(
        request,
        response,
        canister_id.as_slice(),
        current_time_ns,
        max_cert_time_offset_ns,
        ic_root_key,
        MIN_VERIFICATION_VERSION,
    );

    println!("Result: {:?}", result);
}
